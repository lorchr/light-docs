<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="Unit-test-in-spring-boot-application" />
	<meta name="description" content="Unit-test-in-spring-boot-application" />
	<!-- 网页标签标题 -->
	<title>Unit-test-in-spring-boot-application</title>
	<link rel="shortcut icon" href="/light-docs/img/docsite.ico"/>
	<link rel="stylesheet" href="/light-docs/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/light-docs/zh-cn/index.html"><img class="logo" src="/light-docs/img/dubbo_colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/light-docs/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/light-docs/zh-cn/index.html" target="_self">首页</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/light-docs/zh-cn/docs/site/Overview.html" target="_self">文档</a></li><li class="menu-item menu-item-normal"><a href="/light-docs/zh-cn/blog/index.html" target="_self">博客</a></li><li class="menu-item menu-item-normal"><a href="/light-docs/zh-cn/community/index.html" target="_self">社区</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/light-docs/img/system/docs.png" class="front-img"/><span>文档</span><img src="/light-docs/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>Light Docs</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/light-docs/zh-cn/docs/site/Overview.html" target="_self">概览</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/light-docs/zh-cn/docs/site/Quick-Start.html" target="_self">快速开始</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/light-docs/zh-cn/docs/site/Developer-Guide.html" target="_self">开发指南</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/light-docs/zh-cn/docs/single/00-Docsite-Usage.html" target="_self">Docsite 使用</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>开发环境<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/devenv/DevEnv.html" target="_self">总览</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/devenv/Docker-Mysql.html" target="_self">Mysql</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/devenv/Docker-Pgsql.html" target="_self">Pgsql</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/devenv/Docker-Redis.html" target="_self">Redis</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/devenv/Docker-InfluxDB.html" target="_self">InfluxDB</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/devenv/Docker-EMQX.html" target="_self">EMQX</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Spring Boot<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/Spring-Boot/Spring-Boot.html" target="_self">Spring Boot</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Spring Cloud<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/Spring-Cloud/Spring-Cloud.html" target="_self">Spring Cloud</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Spring Security<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/Spring-Security/Spring-Security.html" target="_self">Spring Security</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>CI/CD<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/01-Install-JDK.html" target="_self">Install JDK</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/02-Install-NodeJS.html" target="_self">Install NodeJS</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/03-Install-Maven.html" target="_self">Install Maven</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/04-Install-Gitea.html" target="_self">Install Gitea</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/05-Install-Nexus3.html" target="_self">Install Nexus3</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/06-Install-Jenkins.html" target="_self">Install Jenkins</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/07-Install-Docker Registry.html" target="_self">Install Docker Registry</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/08-Install-Harbor.html" target="_self">Install Harbor</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>K8s<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/K8s/K8s-Single-Master-Cluster.html" target="_self">K8s单Master集群</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/K8s/Use-Rancher-build-K8s-Cluster.html" target="_self">使用Rancher搭建K8s集群</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Linux<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/Linux/Ntp-Time-Sync.html" target="_self">Linux服务器时间同步</a></li></ul></li></ul></li></ul></div><div class="doc-content markdown-body"><p>Spring Boot 提供了丰富的测试功能，主要由以下两个模块组成：</p>
<p>● spring-boot-test：提供测试核心功能。</p>
<p>● spring-boot-test-autoconfigure：提供对测试的自动配置。</p>
<p>Spring Boot 提供了一个 spring-boot-starter-test一站式启动器，如以下依赖配置所示。</p>
<dependency>
 <groupId>org.springframework.boot</groupId>
 <artifactId>spring-boot-starter-test</artifactId>
 <scope>test</scope>
</dependency>
测试启动器依赖不仅包含以上两个 Spring Boot模块，还包含 Spring Test 测试模块，以及其他
<p>第三方测试类库，如下所示。</p>
<p>● JUnit 5：Java 最主流的单元测试框架。</p>
<p>● AssertJ：一款快速断言库。</p>
<p>● Hamcrest：一款单元测试匹配库。</p>
<p>● Mockito：一款 Mock 测试框架。</p>
<p>● JSONassert：一款 JSON 断言库。</p>
<p>● JsonPath：一款 JSON XPath 库。</p>
<p>更多测试相关的依赖可见具体的依赖关系树，如下图所示。</p>
<p>图片</p>
<p>以上这些都是 Spring Boot 提供的常用的测试类库，如果上面的测试类库还不能满足你的需要，也可以任意添加以上没有的类库。</p>
<p>现在基本上使用的是 JUnit 5，如果应用还在使用JUnit 4 写的单元测试用例，那么也可以使用JUnit 5 的 Vintage 引擎来运行，如下面的依赖配置所示。</p>
<dependency>
 <groupId>org.junit.vintage</groupId>
 <artifactId>junit-vintage-engine</artifactId>
 <scope>test</scope>
 <exclusions>
 <exclusion>
 <groupId>org.hamcrest</groupId>
 <artifactId>hamcrest-core</artifactId>
 </exclusion>
 </exclusions>
</dependency>
需要排除 hamcrest-core 依赖，因为该依赖已经改坐标了，并且默认内置在Spring Boot依赖管理中，如上面的依赖关系树所示，最新的 Hamcrest依赖已经是org.hamcrest:hamcrest坐标了。
<p>Spring Boot提供了一个 @SpringBootTest 注解，用在单元测试类上以启用支持Spring Boot特性的单元测试，如果使用的是JUnit 4，那么测试类上还需要额外的@RunWith(SpringRunner. class)注解，然后在测试类方法上添加 @Test 注解即可，每一个 @Test 注解修饰的方法就是一个单元测试方法。</p>
<p>@SpringBootTest 注解有一个最重要的 webEnvironment 环境参数，支持以下几种环境设置：</p>
<p>●MOCK（默认）：加载一个 Web ApplicationContext 并提供一个 Mock Web Environment，但不会启动内嵌的 Web 服务器，并可以结合 @AutoConfifigureMockMvcor 和 @AutoConfifigure-WebTestClient 注解一起使用进行 Mock 测试。</p>
<p>● RANDOM_PORT：加载一个 WebServerApplicationContext，以及提供一个真实的 WebEnvironment，并以随机端口启动内嵌服务器。</p>
<p>●DEFINED_PORT：和 RANDOM_PORT 一样，不同的是 DEFINED_PORT 是以应用指定的端口运行的，默认端口为 8080。</p>
<p>●NONE：加载一个 ApplicationContext，但不会提供任何 Web Environment。</p>
<p>如果使用的 @SpringBootTest 注解不带任何参数，则默认为 Mock 环境。</p>
<p>真实环境测试</p>
<p>在 @SpringBootTest 注解中指定基于随机端口的真实Web环境，然后在类成员变量或者方法参数上注入 TestRestTemplate 实例，就可以完成对 Spring MVC接口的真实环境测试。</p>
<p>下面是一个基于随机端口的真实环境的测试用例：</p>
<p>@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
public class MvcTest {
@Test
public void getUserTest(@Autowired TestRestTemplate testRestTemplate) {
Map&lt;String, String&gt; multiValueMap = new HashMap&lt;&gt;();
multiValueMap.put(&quot;username&quot;, &quot;Java 技术栈 &quot;);
Result result = testRestTemplate.getForObject(&quot;/user/get?username={username}&quot;,
Result.class, multiValueMap);
assertThat(result.getCode()).isEqualTo(0);
assertThat(result.getMsg()).isEqualTo(&quot;ok&quot;);
}</p>
<p>}
测试当前应用下的 /user/get 接口，传入对应的用户名参数，最后检查接口返回结果是否和预期一致，测试结果如下图所示。</p>
<p>图片</p>
<p>单元测试通过，从执行日志可以看到，它启动了一个嵌入式的 Tomcat 容器来测试真实的 Web应用环境。</p>
<p>Mock 环境测试</p>
<p>通过在类上面使用 @AutoConfifigureMockMvc 注解，然后在类成员变量或者方法参数上注入MockMvc 实例，就可以完成对 Spring MVC 接口的 Mock 测试。</p>
<p>下面是一个基于默认 Mock 环境的测试用例：</p>
<p>@SpringBootTest
@AutoConfigureMockMvc
class MockMvcTests {
@Test
public void getUserTest(@Autowired MockMvc mvc) throws Exception {
mvc.perform(MockMvcRequestBuilders.get(&quot;/user/get?username={username}&quot;, &quot;test&quot;))
.andExpect(status().isOk())
.andExpect(content().string(&quot;{&quot;code&quot;:0,&quot;msg&quot;:&quot;ok&quot;,&quot;
data&quot;:&quot;test&quot;}&quot;));
}
}
测试当前应用下的 /user/get 接口，传入对应的用户名参数，最后检查请求状态是否OK（200），响应的内容是否和预期一致，测试结果如下图所示。</p>
<p>图片</p>
<p>单元测试通过，从执行日志可以看到，它并未启动真实的 Web 环境来测试，而是使用 Mock 环境测试的。</p>
<p>Mock 组件测试</p>
<p>某些时候可能还需要模拟一些组件，比如某些服务只有上线之后才能调用，在开发阶段不可用，这时就需要 Mock 模拟测试了，提供各种模拟组件以完成测试。</p>
<p>Spring Boot 提供了一个 @MockBean 注解，可为 Spring 中的 Bean 组件定义基于 Mockito 的Mock 测试，它可以创建一个新 Bean 以覆盖 Spring 环境中已有的 Bean，它可以用在测试类、成员变量上，或者 @Confifiguration 配置类、成员变量上，被模拟的 Bean 在每次测试结束后自动重置。</p>
<p>假现现在有一个远程的服务 userService，本地不能调用，现在进行 Mock 测试，如以下使用示例所示。</p>
<p>@SpringBootTest
class MockBeanTests {
// @Autowired
// private UserService userService;
@MockBean
private UserService userService;
@Test
public void countAllUsers() {
BDDMockito.given(this.userService.countAllUsers()).willReturn(88);
assertThat(this.userService.countAllUsers()).isEqualTo(88);
}
}
这里的 @MockBean 注解使用在 UserService 变量上，表明这个userService实例在当前测试用例中是被 Mock 覆盖的，如果要模拟的 Bean 有多个，则可以使用@Qualififier注解指定，然后通过Mockito 提供的代理工具类方法创建模拟返回数据，运行该服务的测试方法，当模拟数据和预期结果一致时才会测试通过。</p>
<p>这里通过 BDDMockito 工具类模拟 userService#countAllUsers方法并让它返回统计的用户总数（88），最后检查该方法的返回值是否和预期一致，测试结果如下图所示。</p>
<p>图片</p>
<p>单元测试通过，也可以使用 @SpyBean 注解代替 @MockBean 注解，两者的区别是：</p>
<p>● @SpyBean—如果没有提供 Mockito 代理方法，则会调用真实的 Bean 来获取数据。</p>
<p>● @MockBean—不管有没有提供 Mockito 代理方法，都会调用 Mock 的 Bean 来获取数据。</p>
<p>@MockBean、@SpyBean 注解既可作用于 Mock 环境，也可作用于真实环境，它只是用来模拟、替换环境中指定的 Bean 而已，但不能用于模拟在应用上下文刷新期间 Bean 的行为，因为在执行测试用例时应用上下文已经刷新完成了，所以不可能再去模拟了，这种情况下建议使用 @Bean 方法来创建模拟配置。</p>
</div></section><footer class="footer-container"><div class="footer-body"><img src="/light-docs/img/dubbo_gray.png"/><div class="cols-container"><div class="col col-12"><h3>免责声明</h3><p>站点由 https://docsite.js.org 构建</p></div><div class="col col-6"><dl><dt>文档</dt><dd><a href="/light-docs/zh-cn/docs/site/Overview.html" target="_self">概览</a></dd><dd><a href="/light-docs/zh-cn/docs/site/Quick-Start.html" target="_self">快速开始</a></dd><dd><a href="/light-docs/zh-cn/docs/site/Developer-Guide.html" target="_self">开发者指南</a></dd></dl></div><div class="col col-6"><dl><dt>资源</dt><dd><a href="/light-docs/zh-cn/blog/index.html" target="_self">博客</a></dd><dd><a href="/light-docs/zh-cn/community/index.html" target="_self">社区</a></dd></dl></div></div><div class="copyright"><span>Copyright © 2018 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></div><div class="poweredBy"><span>Poered By: https://github.com/txd-team/docsite</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '/light-docs';
  </script>
	<script src="/light-docs/build/documentation.js"></script>
</body>
</html>