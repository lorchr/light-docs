<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="Ntp-Time-Sync" />
	<meta name="description" content="Ntp-Time-Sync" />
	<!-- 网页标签标题 -->
	<title>Ntp-Time-Sync</title>
	<link rel="shortcut icon" href="/light-docs/img/docsite.ico"/>
	<link rel="stylesheet" href="/light-docs/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/light-docs/zh-cn/index.html"><img class="logo" src="/light-docs/img/dubbo_colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/light-docs/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/light-docs/zh-cn/index.html" target="_self">首页</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/light-docs/zh-cn/docs/site/Overview.html" target="_self">文档</a></li><li class="menu-item menu-item-normal"><a href="/light-docs/zh-cn/blog/index.html" target="_self">博客</a></li><li class="menu-item menu-item-normal"><a href="/light-docs/zh-cn/community/index.html" target="_self">社区</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/light-docs/img/system/docs.png" class="front-img"/><span>文档</span><img src="/light-docs/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>Light Docs</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/light-docs/zh-cn/docs/site/Overview.html" target="_self">概览</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/light-docs/zh-cn/docs/site/Quick-Start.html" target="_self">快速开始</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/light-docs/zh-cn/docs/site/Developer-Guide.html" target="_self">开发指南</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/light-docs/zh-cn/docs/single/00-Docsite-Usage.html" target="_self">Docsite 使用</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>开发环境<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/devenv/DevEnv.html" target="_self">总览</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/devenv/Docker-Mysql.html" target="_self">Mysql</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/devenv/Docker-Pgsql.html" target="_self">Pgsql</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/devenv/Docker-Redis.html" target="_self">Redis</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/devenv/Docker-InfluxDB.html" target="_self">InfluxDB</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/devenv/Docker-EMQX.html" target="_self">EMQX</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Spring Boot<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/Spring-Boot/Spring-Boot.html" target="_self">Spring Boot</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Spring Cloud<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/Spring-Cloud/Spring-Cloud.html" target="_self">Spring Cloud</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Spring Security<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/Spring-Security/Spring-Security.html" target="_self">Spring Security</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>CI/CD<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/01-Install-JDK.html" target="_self">Install JDK</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/02-Install-NodeJS.html" target="_self">Install NodeJS</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/03-Install-Maven.html" target="_self">Install Maven</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/04-Install-Gitea.html" target="_self">Install Gitea</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/05-Install-Nexus3.html" target="_self">Install Nexus3</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/06-Install-Jenkins.html" target="_self">Install Jenkins</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/07-Install-Docker Registry.html" target="_self">Install Docker Registry</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/CI-CD/08-Install-Harbor.html" target="_self">Install Harbor</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>K8s<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/K8s/K8s-Single-Master-Cluster.html" target="_self">K8s单Master集群</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/K8s/Use-Rancher-build-K8s-Cluster.html" target="_self">使用Rancher搭建K8s集群</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Linux<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/zh-cn/docs/Linux/Ntp-Time-Sync.html" target="_self">Linux服务器时间同步</a></li></ul></li></ul></li></ul></div><div class="doc-content markdown-body"><h1 id="%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%8C%85">下载安装包 <a class="header-anchor" href="#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%8C%85">#</a></h1>
<p><a href="https://pkgs.org/download/ntp">https://pkgs.org/download/ntp</a></p>
<ul>
<li>autogen-libopts-5.18-5.el7.x86_64.rpm</li>
<li>ntpdate-4.2.6p5-29.el7.centos.2.x86_64.rpm</li>
<li>ntp-4.2.6p5-29.el7.centos.2.x86_64.rpm</li>
</ul>
<h1 id="%E5%AE%89%E8%A3%85ntp">安装NTP <a class="header-anchor" href="#%E5%AE%89%E8%A3%85ntp">#</a></h1>
<pre><code class="language-shell">[root@light pkg]# rpm -ivh autogen-libopts-5.18-5.el7.x86_64.rpm
准备中...                          ################################# [100%]
正在升级/安装...
   1:autogen-libopts-5.18-5.el7       ################################# [100%]
[root@light pkg]# rpm -ivh ntpdate-4.2.6p5-29.el7.centos.2.x86_64.rpm
准备中...                          ################################# [100%]
正在升级/安装...
   1:ntpdate-4.2.6p5-29.el7.centos.2  ################################# [100%]
[root@light pkg]# rpm -ivh ntp-4.2.6p5-29.el7.centos.2.x86_64.rpm
准备中...                          ################################# [100%]
正在升级/安装...
   1:ntp-4.2.6p5-29.el7.centos.2      ################################# [100%]
</code></pre>
<h1 id="%E6%9F%A5%E7%9C%8Bntp%E7%89%88%E6%9C%AC">查看NTP版本 <a class="header-anchor" href="#%E6%9F%A5%E7%9C%8Bntp%E7%89%88%E6%9C%AC">#</a></h1>
<pre><code class="language-shell">[root@light pkg]# rpm -q ntp
ntp-4.2.6p5-29.el7.centos.2.x86_64
</code></pre>
<h1 id="%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8">开机启动 <a class="header-anchor" href="#%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8">#</a></h1>
<pre><code class="language-shell">[root@light pkg]# systemctl enable ntpd
Created symlink from /etc/systemd/system/multi-user.target.wants/ntpd.service to /usr/lib/systemd/system/ntpd.service.
</code></pre>
<h1 id="%E5%90%AF%E5%8A%A8ntp">启动NTP <a class="header-anchor" href="#%E5%90%AF%E5%8A%A8ntp">#</a></h1>
<pre><code class="language-shell">[root@light pkg]# systemctl start ntpd
</code></pre>
<h1 id="%E6%9F%A5%E7%9C%8Bntp%E7%8A%B6%E6%80%81">查看NTP状态 <a class="header-anchor" href="#%E6%9F%A5%E7%9C%8Bntp%E7%8A%B6%E6%80%81">#</a></h1>
<pre><code class="language-shell">[root@light pkg]# systemctl status ntpd
● ntpd.service - Network Time Service
   Loaded: loaded (/usr/lib/systemd/system/ntpd.service; enabled; vendor preset: disabled)
   Active: active (running) since 三 2022-11-23 14:10:01 CST; 6s ago
  Process: 1635 ExecStart=/usr/sbin/ntpd -u ntp:ntp $OPTIONS (code=exited, status=0/SUCCESS)
 Main PID: 1636 (ntpd)
   CGroup: /system.slice/ntpd.service
           └─1636 /usr/sbin/ntpd -u ntp:ntp -g

11月 23 14:10:01 light ntpd[1636]: 0.0.0.0 c01d 0d kern kernel time sync enabled
11月 23 14:10:01 light ntpd[1636]: ntp_io: estimated max descriptors: 1024, initial socket boundary: 16
11月 23 14:10:01 light ntpd[1636]: Listen and drop on 0 v4wildcard 0.0.0.0 UDP 123
11月 23 14:10:01 light ntpd[1636]: Listen and drop on 1 v6wildcard :: UDP 123
11月 23 14:10:01 light ntpd[1636]: Listen normally on 2 lo 127.0.0.1 UDP 123
11月 23 14:10:01 light ntpd[1636]: Listen normally on 3 enp0s3 192.168.137.218 UDP 123
11月 23 14:10:01 light ntpd[1636]: Listen normally on 4 lo ::1 UDP 123
11月 23 14:10:01 light ntpd[1636]: Listen normally on 5 enp0s3 fe80::a3ee:846d:9026:d26c UDP 123
11月 23 14:10:01 light ntpd[1636]: Listening on routing socket on fd #22 for interface updates
11月 23 14:10:06 light ntpd[1636]: Deferring DNS for 0.centos.pool.ntp.org 1
</code></pre>
<h1 id="%E9%85%8D%E7%BD%AEntp">配置NTP <a class="header-anchor" href="#%E9%85%8D%E7%BD%AEntp">#</a></h1>
<pre><code class="language-shell">[root@light pkg]# vim /etc/ntp.conf
<span class="hljs-meta">
#</span><span class="bash"> 日志文件</span>
logfile /var/log/ntpd.log
<span class="hljs-meta">
#</span><span class="bash"> 允许 10.51.0.0 网段的机器从这台服务器上查询和同步时间</span>
restrict 10.51.0.0 mask 255.255.255.0 nomodify notrap
<span class="hljs-meta">
#</span><span class="bash"> 网络时间</span>
server 0.cn.pool.ntp.org iburst prefer
server 1.cn.pool.ntp.org iburst
server 2.cn.pool.ntp.org iburst
server 3.cn.pool.ntp.org iburst
<span class="hljs-meta">
#</span><span class="bash"> 网络时间不可用是使用本地时间</span>
server 127.0.0.1 iburst
fudge 127.0.0.1 stratum 10
<span class="hljs-meta">
#</span><span class="bash"> 允许上层时间服务器主动修改本机时间</span>
restrict 0.cn.pool.ntp.org nomodify notrap noquery
restrict 1.cn.pool.ntp.org nomodify notrap noquery
restrict 2.cn.pool.ntp.org nomodify notrap noquery
restrict 3.cn.pool.ntp.org nomodify notrap noquery
</code></pre>
<p>在 ntp.conf 配置文件内可以利用『 restrict 』來控管权限，这个参数的设定方式为：</p>
<pre><code>restrict [你的IP] mask [netmask_IP] [parameter]
</code></pre>
<p>其中 parameter 的參數主要有底下這些：</p>
<ol>
<li>ignore： 拒絕所有類型的 NTP 連線；</li>
<li>nomodify： 用戶端不能使用 ntpc 與 ntpq 這兩支程式來修改伺服器的時間參數， 但用戶端仍可透過這部主機來進行網路校時的；</li>
<li>noquery： 用戶端不能夠使用 ntpq, ntpc 等指令來查詢時間伺服器，等於不提供 NTP 的網路校時囉；</li>
<li>notrap： 不提供 trap 這個遠端事件登錄 (remote event logging) 的功能。</li>
<li>notrust： 拒絕沒有認證的用戶端。</li>
</ol>
<p>那如果你沒有在 parameter 的地方加上任何參數的話，這表示『該 IP 或網段不受任何限制』的意思喔！一般來說，我們可以先關閉 NTP 的使用權限，然後再一個一個的啟用允許登入的網段。</p>
<h1 id="%E6%9F%A5%E7%9C%8B%E6%97%B6%E9%97%B4%E6%98%AF%E5%90%A6%E5%B7%B2%E5%90%8C%E6%AD%A5">查看时间是否已同步 <a class="header-anchor" href="#%E6%9F%A5%E7%9C%8B%E6%97%B6%E9%97%B4%E6%98%AF%E5%90%A6%E5%B7%B2%E5%90%8C%E6%AD%A5">#</a></h1>
<pre><code class="language-shell">[root@light pkg]# ntpstat
</code></pre>
<h1 id="%E6%9F%A5%E8%AF%A2%E6%97%B6%E9%97%B4">查询时间 <a class="header-anchor" href="#%E6%9F%A5%E8%AF%A2%E6%97%B6%E9%97%B4">#</a></h1>
<pre><code class="language-shell">[root@light pkg]# timedatectl
      Local time: 三 2022-11-23 14:19:18 CST
  Universal time: 三 2022-11-23 06:19:18 UTC
        RTC time: 三 2022-11-23 06:19:18
       Time zone: Asia/Shanghai (CST, +0800)
     NTP enabled: yes
NTP synchronized: no
 RTC in local TZ: no
      DST active: n/a
</code></pre>
<h1 id="%E9%AA%8C%E8%AF%81">验证 <a class="header-anchor" href="#%E9%AA%8C%E8%AF%81">#</a></h1>
<pre><code class="language-shell">[root@light pkg]# ntpdate 192.168.137.218
23 Nov 14:19:48 ntpdate[1712]: the NTP socket is in use, exiting

[root@light pkg]# ntpq -p
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
 ntp6.flashdance 194.58.203.20    2 u   39   64    3  254.847   12.965  26.569
*time.cloudflare 10.209.8.4       3 u   38   64    3  137.763   17.111   1.112
 a.chl.la        131.188.3.222    2 u   95   64    2  241.730    8.827   1.449
 119.28.183.184  100.122.36.196   2 u   34   64    3   38.629   12.979   7.136
 master          .INIT.          16 u    -   64    0    0.000    0.000   0.000
[root@master ~]# vim /etc/ntp.conf
</code></pre>
<p>带有 * 表示是当前正在使用的上层NTP服务器
带有 + 表示可用作备选服务器</p>
<h1 id="%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%90%8C%E6%AD%A5%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1">客户端同步定时任务 <a class="header-anchor" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%90%8C%E6%AD%A5%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1">#</a></h1>
<pre><code class="language-shell">vim /etc/crontab

*/15 * * * * root /usr/sbin/ntpdate 0.cn.pool.ntp.org
</code></pre>
</div></section><footer class="footer-container"><div class="footer-body"><img src="/light-docs/img/dubbo_gray.png"/><div class="cols-container"><div class="col col-12"><h3>免责声明</h3><p>站点由 https://docsite.js.org 构建</p></div><div class="col col-6"><dl><dt>文档</dt><dd><a href="/light-docs/zh-cn/docs/site/Overview.html" target="_self">概览</a></dd><dd><a href="/light-docs/zh-cn/docs/site/Quick-Start.html" target="_self">快速开始</a></dd><dd><a href="/light-docs/zh-cn/docs/site/Developer-Guide.html" target="_self">开发者指南</a></dd></dl></div><div class="col col-6"><dl><dt>资源</dt><dd><a href="/light-docs/zh-cn/blog/index.html" target="_self">博客</a></dd><dd><a href="/light-docs/zh-cn/community/index.html" target="_self">社区</a></dd></dl></div></div><div class="copyright"><span>Copyright © 2018 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></div><div class="poweredBy"><span>Poered By: https://github.com/txd-team/docsite</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '/light-docs';
  </script>
	<script src="/light-docs/build/documentation.js"></script>
</body>
</html>