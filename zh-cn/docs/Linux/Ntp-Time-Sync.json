{
  "filename": "Ntp-Time-Sync.md",
  "__html": "<h1 id=\"%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%8C%85\">下载安装包 <a class=\"header-anchor\" href=\"#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%8C%85\">#</a></h1>\n<p><a href=\"https://pkgs.org/download/ntp\">https://pkgs.org/download/ntp</a></p>\n<ul>\n<li>autogen-libopts-5.18-5.el7.x86_64.rpm</li>\n<li>ntpdate-4.2.6p5-29.el7.centos.2.x86_64.rpm</li>\n<li>ntp-4.2.6p5-29.el7.centos.2.x86_64.rpm</li>\n</ul>\n<h1 id=\"%E5%AE%89%E8%A3%85ntp\">安装NTP <a class=\"header-anchor\" href=\"#%E5%AE%89%E8%A3%85ntp\">#</a></h1>\n<pre><code class=\"language-shell\">[root@light pkg]# rpm -ivh autogen-libopts-5.18-5.el7.x86_64.rpm\n准备中...                          ################################# [100%]\n正在升级/安装...\n   1:autogen-libopts-5.18-5.el7       ################################# [100%]\n[root@light pkg]# rpm -ivh ntpdate-4.2.6p5-29.el7.centos.2.x86_64.rpm\n准备中...                          ################################# [100%]\n正在升级/安装...\n   1:ntpdate-4.2.6p5-29.el7.centos.2  ################################# [100%]\n[root@light pkg]# rpm -ivh ntp-4.2.6p5-29.el7.centos.2.x86_64.rpm\n准备中...                          ################################# [100%]\n正在升级/安装...\n   1:ntp-4.2.6p5-29.el7.centos.2      ################################# [100%]\n</code></pre>\n<h1 id=\"%E6%9F%A5%E7%9C%8Bntp%E7%89%88%E6%9C%AC\">查看NTP版本 <a class=\"header-anchor\" href=\"#%E6%9F%A5%E7%9C%8Bntp%E7%89%88%E6%9C%AC\">#</a></h1>\n<pre><code class=\"language-shell\">[root@light pkg]# rpm -q ntp\nntp-4.2.6p5-29.el7.centos.2.x86_64\n</code></pre>\n<h1 id=\"%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8\">开机启动 <a class=\"header-anchor\" href=\"#%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8\">#</a></h1>\n<pre><code class=\"language-shell\">[root@light pkg]# systemctl enable ntpd\nCreated symlink from /etc/systemd/system/multi-user.target.wants/ntpd.service to /usr/lib/systemd/system/ntpd.service.\n</code></pre>\n<h1 id=\"%E5%90%AF%E5%8A%A8ntp\">启动NTP <a class=\"header-anchor\" href=\"#%E5%90%AF%E5%8A%A8ntp\">#</a></h1>\n<pre><code class=\"language-shell\">[root@light pkg]# systemctl start ntpd\n</code></pre>\n<h1 id=\"%E6%9F%A5%E7%9C%8Bntp%E7%8A%B6%E6%80%81\">查看NTP状态 <a class=\"header-anchor\" href=\"#%E6%9F%A5%E7%9C%8Bntp%E7%8A%B6%E6%80%81\">#</a></h1>\n<pre><code class=\"language-shell\">[root@light pkg]# systemctl status ntpd\n● ntpd.service - Network Time Service\n   Loaded: loaded (/usr/lib/systemd/system/ntpd.service; enabled; vendor preset: disabled)\n   Active: active (running) since 三 2022-11-23 14:10:01 CST; 6s ago\n  Process: 1635 ExecStart=/usr/sbin/ntpd -u ntp:ntp $OPTIONS (code=exited, status=0/SUCCESS)\n Main PID: 1636 (ntpd)\n   CGroup: /system.slice/ntpd.service\n           └─1636 /usr/sbin/ntpd -u ntp:ntp -g\n\n11月 23 14:10:01 light ntpd[1636]: 0.0.0.0 c01d 0d kern kernel time sync enabled\n11月 23 14:10:01 light ntpd[1636]: ntp_io: estimated max descriptors: 1024, initial socket boundary: 16\n11月 23 14:10:01 light ntpd[1636]: Listen and drop on 0 v4wildcard 0.0.0.0 UDP 123\n11月 23 14:10:01 light ntpd[1636]: Listen and drop on 1 v6wildcard :: UDP 123\n11月 23 14:10:01 light ntpd[1636]: Listen normally on 2 lo 127.0.0.1 UDP 123\n11月 23 14:10:01 light ntpd[1636]: Listen normally on 3 enp0s3 192.168.137.218 UDP 123\n11月 23 14:10:01 light ntpd[1636]: Listen normally on 4 lo ::1 UDP 123\n11月 23 14:10:01 light ntpd[1636]: Listen normally on 5 enp0s3 fe80::a3ee:846d:9026:d26c UDP 123\n11月 23 14:10:01 light ntpd[1636]: Listening on routing socket on fd #22 for interface updates\n11月 23 14:10:06 light ntpd[1636]: Deferring DNS for 0.centos.pool.ntp.org 1\n</code></pre>\n<h1 id=\"%E9%85%8D%E7%BD%AEntp\">配置NTP <a class=\"header-anchor\" href=\"#%E9%85%8D%E7%BD%AEntp\">#</a></h1>\n<pre><code class=\"language-shell\">[root@light pkg]# vim /etc/ntp.conf\n<span class=\"hljs-meta\">\n#</span><span class=\"bash\"> 日志文件</span>\nlogfile /var/log/ntpd.log\n<span class=\"hljs-meta\">\n#</span><span class=\"bash\"> 允许 10.51.0.0 网段的机器从这台服务器上查询和同步时间</span>\nrestrict 10.51.0.0 mask 255.255.255.0 nomodify notrap\n<span class=\"hljs-meta\">\n#</span><span class=\"bash\"> 网络时间</span>\nserver 0.cn.pool.ntp.org iburst prefer\nserver 1.cn.pool.ntp.org iburst\nserver 2.cn.pool.ntp.org iburst\nserver 3.cn.pool.ntp.org iburst\n<span class=\"hljs-meta\">\n#</span><span class=\"bash\"> 网络时间不可用是使用本地时间</span>\nserver 127.0.0.1 iburst\nfudge 127.0.0.1 stratum 10\n<span class=\"hljs-meta\">\n#</span><span class=\"bash\"> 允许上层时间服务器主动修改本机时间</span>\nrestrict 0.cn.pool.ntp.org nomodify notrap noquery\nrestrict 1.cn.pool.ntp.org nomodify notrap noquery\nrestrict 2.cn.pool.ntp.org nomodify notrap noquery\nrestrict 3.cn.pool.ntp.org nomodify notrap noquery\n</code></pre>\n<p>在 ntp.conf 配置文件内可以利用『 restrict 』來控管权限，这个参数的设定方式为：</p>\n<pre><code>restrict [你的IP] mask [netmask_IP] [parameter]\n</code></pre>\n<p>其中 parameter 的參數主要有底下這些：</p>\n<ol>\n<li>ignore： 拒絕所有類型的 NTP 連線；</li>\n<li>nomodify： 用戶端不能使用 ntpc 與 ntpq 這兩支程式來修改伺服器的時間參數， 但用戶端仍可透過這部主機來進行網路校時的；</li>\n<li>noquery： 用戶端不能夠使用 ntpq, ntpc 等指令來查詢時間伺服器，等於不提供 NTP 的網路校時囉；</li>\n<li>notrap： 不提供 trap 這個遠端事件登錄 (remote event logging) 的功能。</li>\n<li>notrust： 拒絕沒有認證的用戶端。</li>\n</ol>\n<p>那如果你沒有在 parameter 的地方加上任何參數的話，這表示『該 IP 或網段不受任何限制』的意思喔！一般來說，我們可以先關閉 NTP 的使用權限，然後再一個一個的啟用允許登入的網段。</p>\n<h1 id=\"%E6%9F%A5%E7%9C%8B%E6%97%B6%E9%97%B4%E6%98%AF%E5%90%A6%E5%B7%B2%E5%90%8C%E6%AD%A5\">查看时间是否已同步 <a class=\"header-anchor\" href=\"#%E6%9F%A5%E7%9C%8B%E6%97%B6%E9%97%B4%E6%98%AF%E5%90%A6%E5%B7%B2%E5%90%8C%E6%AD%A5\">#</a></h1>\n<pre><code class=\"language-shell\">[root@light pkg]# ntpstat\n</code></pre>\n<h1 id=\"%E6%9F%A5%E8%AF%A2%E6%97%B6%E9%97%B4\">查询时间 <a class=\"header-anchor\" href=\"#%E6%9F%A5%E8%AF%A2%E6%97%B6%E9%97%B4\">#</a></h1>\n<pre><code class=\"language-shell\">[root@light pkg]# timedatectl\n      Local time: 三 2022-11-23 14:19:18 CST\n  Universal time: 三 2022-11-23 06:19:18 UTC\n        RTC time: 三 2022-11-23 06:19:18\n       Time zone: Asia/Shanghai (CST, +0800)\n     NTP enabled: yes\nNTP synchronized: no\n RTC in local TZ: no\n      DST active: n/a\n</code></pre>\n<h1 id=\"%E9%AA%8C%E8%AF%81\">验证 <a class=\"header-anchor\" href=\"#%E9%AA%8C%E8%AF%81\">#</a></h1>\n<pre><code class=\"language-shell\">[root@light pkg]# ntpdate 192.168.137.218\n23 Nov 14:19:48 ntpdate[1712]: the NTP socket is in use, exiting\n\n[root@light pkg]# ntpq -p\n     remote           refid      st t when poll reach   delay   offset  jitter\n==============================================================================\n ntp6.flashdance 194.58.203.20    2 u   39   64    3  254.847   12.965  26.569\n*time.cloudflare 10.209.8.4       3 u   38   64    3  137.763   17.111   1.112\n a.chl.la        131.188.3.222    2 u   95   64    2  241.730    8.827   1.449\n 119.28.183.184  100.122.36.196   2 u   34   64    3   38.629   12.979   7.136\n master          .INIT.          16 u    -   64    0    0.000    0.000   0.000\n[root@master ~]# vim /etc/ntp.conf\n</code></pre>\n<p>带有 * 表示是当前正在使用的上层NTP服务器\n带有 + 表示可用作备选服务器</p>\n<h1 id=\"%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%90%8C%E6%AD%A5%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1\">客户端同步定时任务 <a class=\"header-anchor\" href=\"#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%90%8C%E6%AD%A5%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1\">#</a></h1>\n<pre><code class=\"language-shell\">vim /etc/crontab\n\n*/15 * * * * root /usr/sbin/ntpdate 0.cn.pool.ntp.org\n</code></pre>\n",
  "link": "/zh-cn/docs/Linux/Ntp-Time-Sync.html",
  "meta": {}
}