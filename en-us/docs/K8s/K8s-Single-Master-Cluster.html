<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="K8s-Single-Master-Cluster" />
	<meta name="description" content="K8s-Single-Master-Cluster" />
	<!-- 网页标签标题 -->
	<title>K8s-Single-Master-Cluster</title>
	<link rel="shortcut icon" href="/light-docs/img/docsite.ico"/>
	<link rel="stylesheet" href="/light-docs/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/light-docs/en-us/index.html"><img class="logo" src="/light-docs/img/dubbo_colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">中</span><div class="header-menu"><img class="header-menu-toggle" src="/light-docs/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/light-docs/en-us/index.html" target="_self">HOME</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/light-docs/en-us/docs/index.html" target="_self">DOCS</a></li><li class="menu-item menu-item-normal"><a href="/light-docs/en-us/blog/index.html" target="_self">BLOG</a></li><li class="menu-item menu-item-normal"><a href="/light-docs/en-us/community/index.html" target="_self">COMMUNITY</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/light-docs/img/system/docs.png" class="front-img"/><span>Documentation</span><img src="/light-docs/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>Light Docs</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/light-docs/en-us/docs/Docsite-Usage.html" target="_self">Docsite Usage</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Spring Boot<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/en-us/docs/Spring-Boot/Spring-Boot.html" target="_self">Spring Boot</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Spring Cloud<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/en-us/docs/Spring-Cloud/Spring-Cloud.html" target="_self">Spring Cloud</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>Spring Security<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/en-us/docs/Spring-Security/Spring-Security.html" target="_self">Spring Security</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>CI/CD<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/en-us/docs/CI-CD/01-Install-JDK.html" target="_self">Install JDK</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/en-us/docs/CI-CD/02-Install-NodeJS.html" target="_self">Install NodeJS</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/en-us/docs/CI-CD/03-Install-Maven.html" target="_self">Install Maven</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/en-us/docs/CI-CD/04-Install-Gitea.html" target="_self">Install Gitea</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/en-us/docs/CI-CD/05-Install-Nexus3.html" target="_self">Install Nexus3</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/en-us/docs/CI-CD/06-Install-Jenkins.html" target="_self">Install Jenkins</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/en-us/docs/CI-CD/07-Install-Docker-Registry.html" target="_self">Install Docker Registry</a></li><li class="menu-item menu-item-level-3"><a href="/light-docs/en-us/docs/CI-CD/08-Install-Harbor.html" target="_self">Install Harbor</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><span>K8s<img style="transform:rotate(-90deg)" class="menu-toggle" src="/light-docs/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/light-docs/en-us/docs/K8s/K8s-Single-Master-Cluster.html" target="_self">K8s Single Master Cluster</a></li></ul></li></ul></li></ul></div><div class="doc-content markdown-body"><p>[TOC]</p>
<p>单Master服务器规划：</p>
<table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
<th>组件</th>
</tr>
</thead>
<tbody>
<tr>
<td>master</td>
<td>192.168.137.101</td>
<td></td>
</tr>
<tr>
<td>node1</td>
<td>192.168.137.102</td>
<td></td>
</tr>
<tr>
<td>node2</td>
<td>192.168.137.103</td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="%E4%B8%80%E3%80%81-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87">一、 环境准备 <a class="header-anchor" href="#%E4%B8%80%E3%80%81-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87">#</a></h1>
<h3 id="1.-%E5%88%87%E6%8D%A2%E5%8F%8A%E6%B7%BB%E5%8A%A0%E5%AE%89%E8%A3%85%E6%BA%90">1. 切换及添加安装源 <a class="header-anchor" href="#1.-%E5%88%87%E6%8D%A2%E5%8F%8A%E6%B7%BB%E5%8A%A0%E5%AE%89%E8%A3%85%E6%BA%90">#</a></h3>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 安装 wget</span>
yum -y install wget
<span class="hljs-meta">
#</span><span class="bash"> 备份主仓库</span>
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak
<span class="hljs-meta">
#</span><span class="bash"> 切换主仓库</span>
wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
<span class="hljs-meta">
#</span><span class="bash"> 设置epel仓库</span>
wget -O /etc/yum.repos.d/epel-7.repo https://mirrors.aliyun.com/repo/epel-7.repo
<span class="hljs-meta">
#</span><span class="bash"> 设置Docker仓库</span>
wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
<span class="hljs-meta">
#</span><span class="bash"> 设置K8s源仓库</span>
cat &lt;&lt; EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
<span class="hljs-meta">
#</span><span class="bash"> 清除并重建缓存，禁掉GPG验证检查，没有签名的软件安装加这个参数</span>
yum clean all &amp;&amp; yum makecache fast --nogpgcheck
</code></pre>
<h3 id="2.-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96">2. 安装依赖 <a class="header-anchor" href="#2.-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96">#</a></h3>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 安装epel</span>
yum install -y epel-release
<span class="hljs-meta">
#</span><span class="bash"> 安装依赖</span>
yum install -y \
  vim* \
  lrzsz \
  net-tools \
  ifconfig \
  yum-utils \
  netcat \
  ntpdate
</code></pre>
<h3 id="3.-%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BE%E7%BD%AE">3. 服务器设置 <a class="header-anchor" href="#3.-%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BE%E7%BD%AE">#</a></h3>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 关闭防火墙</span>
systemctl stop firewalld &amp;&amp; systemctl disable firewalld
<span class="hljs-meta">
#</span><span class="bash"> 关闭selinux</span>
<span class="hljs-meta">#</span><span class="bash"> 永久</span>
sed -i 's/enforcing/disabled/' /etc/selinux/config
<span class="hljs-meta">#</span><span class="bash"> 临时</span>
setenforce 0
<span class="hljs-meta">
#</span><span class="bash"> 关闭swap</span>
<span class="hljs-meta">#</span><span class="bash"> 临时</span>
swapoff -a
<span class="hljs-meta">#</span><span class="bash"> 永久</span>
sed -ri 's/.*swap.*/#&amp;/' /etc/fstab
<span class="hljs-meta">#</span><span class="bash"> 检查，确保swap里面没有东西</span>
free -m
<span class="hljs-meta">
#</span><span class="bash"> 根据规划设置主机名</span>
hostnamectl set-hostname &lt;hostname&gt;
<span class="hljs-meta">#</span><span class="bash"> 查看修改结果</span>
hostnamectl status
<span class="hljs-meta">#</span><span class="bash"> 修改hosts文件</span>
echo "127.0.0.1 $(hostname)" &gt;&gt; /etc/hosts
<span class="hljs-meta">
#</span><span class="bash"> 在master添加hosts</span>
cat &gt;&gt; /etc/hosts &lt;&lt; EOF
192.168.137.101 master
192.168.137.102 node1
EOF
<span class="hljs-meta">
#</span><span class="bash"> 配置桥接流量</span>
cat &lt;&lt; EOF | sudo tee /etc/modules-load.d/k8s.conf
br_netfilter
EOF
<span class="hljs-meta">
#</span><span class="bash"> 将桥接的IPv4流量传递到iptables的链</span>
cat &lt;&lt; EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
<span class="hljs-meta">
#</span><span class="bash"> 配置生效</span>
sysctl --system
<span class="hljs-meta">
#</span><span class="bash"> 时间同步</span>
ntpdate time.windows.com
<span class="hljs-meta">
#</span><span class="bash"> 关机 重启</span>
shutdown now 
shutdown -r now
reboot -n
</code></pre>
<h1 id="%E4%BA%8C%E3%80%81%E5%AE%89%E8%A3%85docker%2Fkubeadm%2Fkubelet">二、安装Docker/kubeadm/kubelet <a class="header-anchor" href="#%E4%BA%8C%E3%80%81%E5%AE%89%E8%A3%85docker%2Fkubeadm%2Fkubelet">#</a></h1>
<p>Kubernetes默认CRI（容器运行时）为Docker，因此先安装Docker。</p>
<h3 id="1.-%E5%AE%89%E8%A3%85docker">1. 安装Docker <a class="header-anchor" href="#1.-%E5%AE%89%E8%A3%85docker">#</a></h3>
<ul>
<li><a href="https://docs.docker.com/engine/install/centos/">https://docs.docker.com/engine/install/centos/</a></li>
</ul>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 配置仓库</span>
sudo yum install -y yum-utils
sudo yum-config-manager \
  --add-repo \
  https://download.docker.com/linux/centos/docker-ce.repo
<span class="hljs-meta">
#</span><span class="bash"> 清除之前的Docker</span>
sudo yum remove docker \
          docker-client \
          docker-client-latest \
          docker-common \
          docker-latest \
          docker-latest-logrotate \
          docker-logrotate \
          docker-engine
<span class="hljs-meta">
#</span><span class="bash"> 查看Docker版本</span>
yum list docker-ce --showduplicates | sort -r
<span class="hljs-meta">
#</span><span class="bash"> 安装Docker</span>
yum -y install docker-ce-18.06.1.ce-3.el7
<span class="hljs-meta">
#</span><span class="bash"> 启动Docker并设置自动重启</span>
systemctl start docker &amp;&amp; systemctl enable docker
<span class="hljs-meta">
#</span><span class="bash"> 配置镜像下载加速器：</span>
cat &gt; /etc/docker/daemon.json &lt;&lt; EOF
{
  "registry-mirrors": ["https://rv4ppfhe.mirror.aliyuncs.com"],
  "exec-opts": ["native.cgroupdriver=systemd"]
}
EOF
<span class="hljs-meta">
#</span><span class="bash"> 更新配置后重启</span>
systemctl daemon-reload &amp;&amp; systemctl restart docker
<span class="hljs-meta">
#</span><span class="bash"> 普通用户操作Docker</span>
sudo cat /etc/group | grep docker
<span class="hljs-meta">
#</span><span class="bash"> docker用户组不存在则添加用户组</span>
<span class="hljs-meta">#</span><span class="bash"> sudo groupadd docker </span>
<span class="hljs-meta">
#</span><span class="bash"> 将当前用户添加到docker组中</span>
sudo usermod -aG docker $USER
sudo usermod -aG dockerroot $USER
<span class="hljs-meta">
#</span><span class="bash"> 开启Docker远程访问</span>
vim /lib/systemd/system/docker.service
ExecStart=/usr/bin/dockerd -H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375
<span class="hljs-meta">
#</span><span class="bash"> 查看2375端口是否开启</span>
netstat -nlp | grep docker
</code></pre>
<h3 id="2.-%E5%AE%89%E8%A3%85docker-compose">2. 安装Docker Compose <a class="header-anchor" href="#2.-%E5%AE%89%E8%A3%85docker-compose">#</a></h3>
<ul>
<li><a href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a></li>
<li><a href="https://docs.docker.com/compose/install/compose-plugin/">https://docs.docker.com/compose/install/compose-plugin/</a></li>
</ul>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 安装Docker Compose</span>
yum install -y docker-compose-plugin
<span class="hljs-meta">
#</span><span class="bash"> 下载</span>
curl -SL https://github.com/docker/compose/releases/download/v2.7.0/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
<span class="hljs-meta">
#</span><span class="bash"> 添加执行权限</span>
chmod +x /usr/local/bin/docker-compose
<span class="hljs-meta">
#</span><span class="bash"> 链接</span>
sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
<span class="hljs-meta">
#</span><span class="bash"> 测试</span>
docker-compose version
<span class="hljs-meta">
#</span><span class="bash"> 传输文件</span>
scp /usr/local/bin/docker-compose root@192.168.137.102:/usr/local/bin/docker-compose
</code></pre>
<h3 id="3.-docker-overlay2%E5%8D%A0%E7%94%A8%E5%A4%A7%E9%87%8F%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95">3. Docker overlay2占用大量磁盘空间解决办法 <a class="header-anchor" href="#3.-docker-overlay2%E5%8D%A0%E7%94%A8%E5%A4%A7%E9%87%8F%E7%A3%81%E7%9B%98%E7%A9%BA%E9%97%B4%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95">#</a></h3>
<ol>
<li>首先找到overlay2目录</li>
</ol>
<blockquote>
<p>cd /var/lib/docker/overlay2</p>
</blockquote>
<ol start="2">
<li>查看文件的大小</li>
</ol>
<blockquote>
<p>du -h --max-depth=1 /var/lib/docker/overlay2 | grep [MGT] | sort -nr
如下所示，找到大小为500G的文件</p>
</blockquote>
<ol start="3">
<li>查看占用空间的pid，以及对应的容器名称</li>
</ol>
<blockquote>
<p>docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}, {{.GraphDriver.Data.WorkDir}}' | grep &quot;09151aa1dd70a8884a9f6ab3f31b0b530be8a7a5fb78c25f4f51901440089681&quot;
结果如下：</p>
</blockquote>
<ol start="4">
<li>解决方法（会删除对应的容器和对应镜像）：</li>
</ol>
<blockquote>
<p>docker stop ainews_processB &amp;&amp; docker rm ainews_processB &amp;&amp; docker rmi image_id</p>
</blockquote>
<h3 id="4.-%E5%AE%89%E8%A3%85k8s">4. 安装K8s <a class="header-anchor" href="#4.-%E5%AE%89%E8%A3%85k8s">#</a></h3>
<ul>
<li><a href="https://kubernetes.io/docs/getting-started-guides/kubeadm/">https://kubernetes.io/docs/getting-started-guides/kubeadm/</a></li>
<li><a href="https://kubernetes.io/docs/setup/production-environment/tools/">https://kubernetes.io/docs/setup/production-environment/tools/</a></li>
<li><a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/</a></li>
</ul>
<p>由于版本更新频繁，这里指定版本号部署：</p>
<ul>
<li>kubelet：systemd守护进程管理</li>
<li>kubeadm：部署工具</li>
<li>kubectl：k8s命令行管理工具</li>
</ul>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 检查Master6443端口占用</span>
nc 127.0.0.1 6443
<span class="hljs-meta">
#</span><span class="bash">  卸载旧版本</span>
yum remove -y kubelet kubeadm kubectl
<span class="hljs-meta">
#</span><span class="bash"> 查看k8s的版本</span>
yum list kubelet --showduplicates | sort -r 
<span class="hljs-meta">
#</span><span class="bash"> 安装K8s</span>
yum install -y \
  kubelet-1.18.0 \
  kubeadm-1.18.0 \
  kubectl-1.18.0
<span class="hljs-meta">
#</span><span class="bash"> 启动kubelet</span>
systemctl start kubelet &amp;&amp; systemctl enable kubelet
<span class="hljs-meta">
#</span><span class="bash"> 查看kubelet状态</span>
systemctl status kubelet
</code></pre>
<h1 id="%E4%B8%89%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96k8s-master%E8%8A%82%E7%82%B9">三、初始化K8s Master节点 <a class="header-anchor" href="#%E4%B8%89%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96k8s-master%E8%8A%82%E7%82%B9">#</a></h1>
<h3 id="1.-%E5%9C%A8192.168.137.101%EF%BC%88master%EF%BC%89%E6%89%A7%E8%A1%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E5%91%BD%E4%BB%A4">1. 在192.168.137.101（Master）执行初始化命令 <a class="header-anchor" href="#1.-%E5%9C%A8192.168.137.101%EF%BC%88master%EF%BC%89%E6%89%A7%E8%A1%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E5%91%BD%E4%BB%A4">#</a></h3>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 查看kubeadm需要下载的镜像</span>
kubeadm config images list 
<span class="hljs-meta">#</span><span class="bash"> 提前下载需要的镜像</span>
<span class="hljs-meta">#</span><span class="bash"> kubeadm config images pull</span>
<span class="hljs-meta">
#</span><span class="bash"> 挨个下载以上镜像，由于是国外镜像，使用阿里云镜像仓库下载</span>
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.18.0
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.18.0
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.18.0
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.18.0
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.4.3-0
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.6.7
<span class="hljs-meta">
#</span><span class="bash"> 因为coredns是带二级目录的，所以要多执行这一步</span>
<span class="hljs-meta">#</span><span class="bash"> docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.8.6 registry.cn-hangzhou.aliyuncs.com/google_containers/coredns/coredns:1.6.7</span>
<span class="hljs-meta">
#</span><span class="bash"> 查看eth0的inet私有网络地址，复制出来填入apiserver-advertise-address</span>
ip addr
<span class="hljs-meta">
#</span><span class="bash"> 初始化Master节点</span>
<span class="hljs-meta">#</span><span class="bash"> image-respository  镜像仓库的地址</span>
<span class="hljs-meta">#</span><span class="bash"> service-cidr pod-network-cidr 设定两个子网范围，不能和apiserver冲突</span>
kubeadm init \
  --apiserver-advertise-address=192.168.137.101 \
  --image-repository registry.aliyuncs.com/google_containers \
  --kubernetes-version v1.18.0 \
  --service-cidr=10.96.0.0/12 \
  --pod-network-cidr=10.244.0.0/16 \
  --ignore-preflight-errors=all
</code></pre>
<p>打印如下信息成功：</p>
<pre><code class="language-shell">W0823 17:52:46.436675    8256 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]
[init] Using Kubernetes version: v1.18.0
[preflight] Running pre-flight checks
[preflight] Pulling images required for setting up a Kubernetes cluster
[preflight] This might take a minute or two, depending on the speed of your internet connection
[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Starting the kubelet
[certs] Using certificateDir folder "/etc/kubernetes/pki"
[certs] Generating "ca" certificate and key
[certs] Generating "apiserver" certificate and key
[certs] apiserver serving cert is signed for DNS names [master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.137.101]
[certs] Generating "apiserver-kubelet-client" certificate and key
[certs] Generating "front-proxy-ca" certificate and key
[certs] Generating "front-proxy-client" certificate and key
[certs] Generating "etcd/ca" certificate and key
[certs] Generating "etcd/server" certificate and key
[certs] etcd/server serving cert is signed for DNS names [master localhost] and IPs [192.168.137.101 127.0.0.1 ::1]
[certs] Generating "etcd/peer" certificate and key
[certs] etcd/peer serving cert is signed for DNS names [master localhost] and IPs [192.168.137.101 127.0.0.1 ::1]
[certs] Generating "etcd/healthcheck-client" certificate and key
[certs] Generating "apiserver-etcd-client" certificate and key
[certs] Generating "sa" key and public key
[kubeconfig] Using kubeconfig folder "/etc/kubernetes"
[kubeconfig] Writing "admin.conf" kubeconfig file
[kubeconfig] Writing "kubelet.conf" kubeconfig file
[kubeconfig] Writing "controller-manager.conf" kubeconfig file
[kubeconfig] Writing "scheduler.conf" kubeconfig file
[control-plane] Using manifest folder "/etc/kubernetes/manifests"
[control-plane] Creating static Pod manifest for "kube-apiserver"
[control-plane] Creating static Pod manifest for "kube-controller-manager"
W0823 17:53:10.225513    8256 manifests.go:225] the default kube-apiserver authorization-mode is "Node,RBAC"; using "Node,RBAC"
[control-plane] Creating static Pod manifest for "kube-scheduler"
W0823 17:53:10.226495    8256 manifests.go:225] the default kube-apiserver authorization-mode is "Node,RBAC"; using "Node,RBAC"
[etcd] Creating static Pod manifest for local etcd in "/etc/kubernetes/manifests"
[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory "/etc/kubernetes/manifests". This can take up to 4m0s
[apiclient] All control plane components are healthy after 24.503745 seconds
[upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace
[kubelet] Creating a ConfigMap "kubelet-config-1.18" in namespace kube-system with the configuration for the kubelets in the cluster
[upload-certs] Skipping phase. Please see --upload-certs
[mark-control-plane] Marking the node master as control-plane by adding the label "node-role.kubernetes.io/master=''"
[mark-control-plane] Marking the node master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]
[bootstrap-token] Using token: ftlxtx.pqomr1j82debo3ph
[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes
[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
[bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace
[kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key
[addons] Applied essential addon: CoreDNS
[addons] Applied essential addon: kube-proxy

Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.137.101:6443 --token ftlxtx.pqomr1j82debo3ph \
    --discovery-token-ca-cert-hash sha256:6406f96f7b11ef7ed750c4da41ac825a63bca63d8dece634197abc23184371ab
</code></pre>
<h3 id="2.-%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E6%93%8D%E4%BD%9Ck8s%E6%9D%83%E9%99%90">2. 普通用户操作K8s权限 <a class="header-anchor" href="#2.-%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7%E6%93%8D%E4%BD%9Ck8s%E6%9D%83%E9%99%90">#</a></h3>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 切换到普通用户，给普通用户增加操作k8s的权限</span>
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
<span class="hljs-meta">
#</span><span class="bash"> 查看Master节点的情况</span>
kubectl get nodes

NAME     STATUS     ROLES    AGE     VERSION
master   NotReady   master   2m55s   v1.18.0
<span class="hljs-meta">
 #</span><span class="bash"> 查看kubelet日志</span>
journalctl -u kubelet
<span class="hljs-meta">#</span><span class="bash"> 重启kubelet</span>
systemctl daemon-reload &amp;&amp; systemctl restart kubelet
</code></pre>
<h1 id="%E5%9B%9B%E3%80%81%E6%B3%A8%E5%86%8Ck8s-node%E8%8A%82%E7%82%B9">四、注册K8s Node节点 <a class="header-anchor" href="#%E5%9B%9B%E3%80%81%E6%B3%A8%E5%86%8Ck8s-node%E8%8A%82%E7%82%B9">#</a></h1>
<p>向集群添加新节点，执行在kubeadm init输出的kubeadm join命令：</p>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 如果Token失效，重新生成</span>
kubeadm token create --print-join-command
<span class="hljs-meta">
#</span><span class="bash"> 注册从节点</span>
kubeadm join 192.168.137.101:6443 --token ftlxtx.pqomr1j82debo3ph \
    --discovery-token-ca-cert-hash sha256:6406f96f7b11ef7ed750c4da41ac825a63bca63d8dece634197abc23184371ab
<span class="hljs-meta">
#</span><span class="bash"> 查看集群节点</span>
kubectl get nodes
NAME     STATUS     ROLES    AGE     VERSION
master   NotReady   master   5m22s   v1.18.0
node1    NotReady   &lt;none&gt;   77s     v1.18.0
</code></pre>
<pre><code class="language-shell">W0823 17:57:30.170836    8459 join.go:346] [preflight] WARNING: JoinControlPane.controlPlane settings will be ignored when control-plane flag is not set.
[preflight] Running pre-flight checks
        [WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd". Please follow the guide at https://kubernetes.io/docs/setup/cri/
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[kubelet-start] Downloading configuration for the kubelet from the "kubelet-config-1.18" ConfigMap in the kube-system namespace
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Starting the kubelet
[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.
</code></pre>
<h1 id="%E4%BA%94%E3%80%81%E9%83%A8%E7%BD%B2%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%EF%BC%88cni%EF%BC%89">五、部署容器网络（CNI） <a class="header-anchor" href="#%E4%BA%94%E3%80%81%E9%83%A8%E7%BD%B2%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C%EF%BC%88cni%EF%BC%89">#</a></h1>
<h3 id="1.-%E5%9C%A8master%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2flannel">1. 在Master节点部署flannel <a class="header-anchor" href="#1.-%E5%9C%A8master%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2flannel">#</a></h3>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 下载flannel启动文件</span>
wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
<span class="hljs-meta">
#</span><span class="bash"> 查看Pods状态</span>
kubectl get pods -A
<span class="hljs-meta">
#</span><span class="bash"> 执行网络安装配置</span>
kubectl apply -f kube-flannel.yml
<span class="hljs-meta">
#</span><span class="bash"> 安装完成后查询网络</span>
kubectl get pods -A
<span class="hljs-meta">#</span><span class="bash"> kubectl get pods -n kube-system</span>
</code></pre>
<p>安装前后执行结果</p>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 安装前</span>
[lorch@master ~]$ kubectl get pods -n kube-system
NAME                             READY   STATUS    RESTARTS   AGE
coredns-7ff77c879f-k82td         0/1     Pending   0          5m45s
coredns-7ff77c879f-ldvq8         0/1     Pending   0          5m45s
etcd-master                      1/1     Running   0          5m55s
kube-apiserver-master            1/1     Running   0          5m55s
kube-controller-manager-master   1/1     Running   0          5m55s
kube-proxy-565f8                 1/1     Running   0          5m45s
kube-proxy-hfzcx                 1/1     Running   0          2m
kube-scheduler-master            1/1     Running   0          5m55s
<span class="hljs-meta">
#</span><span class="bash"> 安装后</span>
NAMESPACE      NAME                             READY   STATUS    RESTARTS   AGE
kube-flannel   kube-flannel-ds-lm4rc            1/1     Running   0          2m52s
kube-flannel   kube-flannel-ds-vg2db            1/1     Running   0          2m52s
kube-system    coredns-7ff77c879f-k82td         1/1     Running   0          7m43s
kube-system    coredns-7ff77c879f-ldvq8         1/1     Running   0          7m43s
kube-system    etcd-master                      1/1     Running   0          7m53s
kube-system    kube-apiserver-master            1/1     Running   0          7m53s
kube-system    kube-controller-manager-master   1/1     Running   0          7m53s
kube-system    kube-proxy-565f8                 1/1     Running   0          7m43s
kube-system    kube-proxy-hfzcx                 1/1     Running   0          3m58s
kube-system    kube-scheduler-master            1/1     Running   0          7m53s
</code></pre>
<h3 id="2.-%E7%BB%99%E9%9B%86%E7%BE%A4%E6%89%93tag%EF%BC%88%E8%B7%B3%E8%BF%87%EF%BC%89">2. 给集群打Tag（跳过） <a class="header-anchor" href="#2.-%E7%BB%99%E9%9B%86%E7%BE%A4%E6%89%93tag%EF%BC%88%E8%B7%B3%E8%BF%87%EF%BC%89">#</a></h3>
<pre><code class="language-shell">kubectl label node k8s-node1 node.kubernetes.io/worker=''
<span class="hljs-meta">#</span><span class="bash"> k8s-node1是节点的hostname</span>
<span class="hljs-meta">#</span><span class="bash"> node.kubernetes.io是固定写法不可变</span>
<span class="hljs-meta">#</span><span class="bash"> worker是给节点加的标签</span>
<span class="hljs-meta">#</span><span class="bash"> =<span class="hljs-string">''</span>无所谓，<span class="hljs-string">''</span>里面可以随便写</span>
<span class="hljs-meta">
#</span><span class="bash"> 去除标签采用命令</span>
kubectl label node k8s-node1 node.kubernetes.io/worker-
</code></pre>
<h3 id="3.-%E8%AE%BE%E7%BD%AEipvs%E6%A8%A1%E5%BC%8F%EF%BC%88%E8%B7%B3%E8%BF%87%EF%BC%89">3. 设置ipvs模式（跳过） <a class="header-anchor" href="#3.-%E8%AE%BE%E7%BD%AEipvs%E6%A8%A1%E5%BC%8F%EF%BC%88%E8%B7%B3%E8%BF%87%EF%BC%89">#</a></h3>
<p>因为linux默认采用的是iptables模式，性能开销非常大，当你集群节点一多，每个节点的kube-proxy都要去同步iptables，可能一天都同步不完。</p>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 查看kube-proxy默认的模式</span>
kubectl logs -n kube-system kube-proxy-565f8
<span class="hljs-meta">
#</span><span class="bash"> 打开编辑kube-proxy的配置文件</span>
kubectl edit cm kube-proxy -n kube-system
<span class="hljs-meta">
#</span><span class="bash"> 找到如下配置：</span>
ipvs:
   excludeCIDRs: null
   minSyncPeriod: 0s
   scheduler: ""
   strictARP: false
   syncPeriod: 0s
   tcpFinTimeout: 0s
   tcpTimeout: 0s
   udpTimeout: 0s
kind: KubeProxyConfiguration
metricsBindAddress: ""
mode: ""
</code></pre>
<p>mode中加入ipvs，保存后退出。</p>
<h3 id="4.-%E9%87%8D%E5%90%AFkube-proxy%EF%BC%88%E8%B7%B3%E8%BF%87%EF%BC%89">4. 重启kube-proxy（跳过） <a class="header-anchor" href="#4.-%E9%87%8D%E5%90%AFkube-proxy%EF%BC%88%E8%B7%B3%E8%BF%87%EF%BC%89">#</a></h3>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 查看所有Pods</span>
kubectl get pod -A -o wide
<span class="hljs-meta">
#</span><span class="bash"> 找到kube-proxy-565f8 ，删除他，不用担心他会自动重启，配置就生效了，-n后面跟的是他的命名空间。</span>
kubectl delete pod kube-proxy-565f8 -n kube-system
<span class="hljs-meta">
#</span><span class="bash"> 等待重启后重新查看状态</span>
kubectl get pod -A | grep kube-proxy
</code></pre>
<h1 id="%E5%85%AD%E3%80%81%E9%83%A8%E7%BD%B2%E5%AE%98%E6%96%B9dashboard%EF%BC%88ui%EF%BC%89">六、部署官方Dashboard（UI） <a class="header-anchor" href="#%E5%85%AD%E3%80%81%E9%83%A8%E7%BD%B2%E5%AE%98%E6%96%B9dashboard%EF%BC%88ui%EF%BC%89">#</a></h1>
<h3 id="1.-%E9%83%A8%E7%BD%B2dashboard">1. 部署Dashboard <a class="header-anchor" href="#1.-%E9%83%A8%E7%BD%B2dashboard">#</a></h3>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 下载官方Dashboard文件</span>
wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.3/aio/deploy/recommended.yaml
<span class="hljs-meta">
#</span><span class="bash"> 安装官方Dashboard</span>
kubectl apply -f recommended.yaml
<span class="hljs-meta">
#</span><span class="bash"> 查看Dashboard启动情况</span>
kubectl get pods -n kubernetes-dashboard

NAME                                         READY   STATUS              RESTARTS   AGE
dashboard-metrics-scraper-6b4884c9d5-94r7k   0/1     ContainerCreating   0          3s
kubernetes-dashboard-7f99b75bf4-xgvf6        0/1     ContainerCreating   0          4s
<span class="hljs-meta">
#</span><span class="bash"> 查看Dashboard服务</span>
kubectl get svc -n kubernetes-dashboard

NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
dashboard-metrics-scraper   ClusterIP   10.110.248.145   &lt;none&gt;        8000/TCP   15h
kubernetes-dashboard        ClusterIP   10.96.248.50     &lt;none&gt;        443/TCP    15h
<span class="hljs-meta">
#</span><span class="bash"> 删除现有的Dashboard服务</span>
<span class="hljs-meta">#</span><span class="bash"> 该服务的类型是ClusterIP，不便于我们通过浏览器访问，因此需要改成NodePort型的</span>
kubectl delete service kubernetes-dashboard -n kubernetes-dashboard
<span class="hljs-meta">
#</span><span class="bash"> 修改配置</span>
kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
<span class="hljs-meta">  #</span><span class="bash"> 增加<span class="hljs-built_in">type</span>为 nodePort</span>
  type: NodePort
  ports:
    - port: 443
      targetPort: 8443
      # 设置映射的端口
      nodePort: 30001
  selector:
    k8s-app: kubernetes-dashboard
<span class="hljs-meta">
#</span><span class="bash"> 再次部署</span>
kubectl apply -f recommended.yaml
<span class="hljs-meta">
#</span><span class="bash"> 再次查看服务</span>
kubectl get svc -n kubernetes-dashboard

NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE
dashboard-metrics-scraper   ClusterIP   10.110.248.145   &lt;none&gt;        8000/TCP        16h
kubernetes-dashboard        NodePort    10.96.248.50     &lt;none&gt;        443:30001/TCP   16h
</code></pre>
<p>访问地址：<a href="http://192.168.137.101:30001">http://192.168.137.101:30001</a></p>
<pre><code class="language-shell">kubectl get deployment --namespace=kubernetes-dashboard kubernetes-dashboard
<span class="hljs-meta">#</span><span class="bash"> 或</span>
kubectl describe deployment --namespace=kubernetes-dashboard kubernetes-dashboard
<span class="hljs-meta">
#</span><span class="bash"> 查看service</span>
kubectl get service --namespace=kubernetes-dashboard kubernetes-dashboard
<span class="hljs-meta">
#</span><span class="bash"> 另外查看pod状态</span>
kubectl get pod --namespace=kubernetes-dashboard -o wide | grep dashboard
<span class="hljs-meta">
#</span><span class="bash"> 输出</span>
dashboard-metrics-scraper-6b4884c9d5-94r7k   1/1     Running   1          14h   10.244.1.4   node1   &lt;none&gt;           &lt;none&gt;
kubernetes-dashboard-7f99b75bf4-xgvf6        1/1     Running   1          14h   10.244.1.5   node1   &lt;none&gt;           &lt;none&gt;
</code></pre>
<p>如果状态一直是 ContainerCreating, 使用describe查看具体过程</p>
<pre><code class="language-shell">kubectl describe pod --namespace=kubernetes-dashboard
<span class="hljs-meta">
#</span><span class="bash"> 输出</span>
Events:
  Type    Reason     Age        From               Message
  ----    ------     ----       ----               -------
  Normal  Scheduled  &lt;unknown&gt;  default-scheduler  Successfully assigned kubernetes-dashboard/kubernetes-dashboard-7b544877d5-cd2b7 to ttg12
  Normal  Pulling    9m36s      kubelet, ttg12     Pulling image "kubernetesui/dashboard:v2.0.0"
</code></pre>
<h3 id="2.-%E5%88%9B%E5%BB%BAserviceaccount%E5%B9%B6%E7%BB%91%E5%AE%9A%E9%BB%98%E8%AE%A4cluster-admin%E7%AE%A1%E7%90%86%E5%91%98%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2%EF%BC%9A">2. 创建ServiceAccount并绑定默认cluster-admin管理员集群角色： <a class="header-anchor" href="#2.-%E5%88%9B%E5%BB%BAserviceaccount%E5%B9%B6%E7%BB%91%E5%AE%9A%E9%BB%98%E8%AE%A4cluster-admin%E7%AE%A1%E7%90%86%E5%91%98%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2%EF%BC%9A">#</a></h3>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 创建用户</span>
kubectl create serviceaccount dashboard-admin -n kube-system
<span class="hljs-meta">
#</span><span class="bash"> 用户授权</span>
kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin
<span class="hljs-meta">
#</span><span class="bash"> 获取用户Token</span>
kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}')
<span class="hljs-meta">
#</span><span class="bash"> 使用输出的Token登录Dashboard。</span>

Name:         dashboard-admin-token-9jtrl
Namespace:    kube-system
Labels:       &lt;none&gt;
Annotations:  kubernetes.io/service-account.name: dashboard-admin
              kubernetes.io/service-account.uid: c5ce8850-1c33-41e7-b17d-336bcde4ec6e

Type:  kubernetes.io/service-account-token

Data
====
ca.crt:     1025 bytes
namespace:  11 bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6Il9HcDhZZmNiVTVHVTZsbDhxY29DNVUybnYzREZxMFUySGpLYmVxWGtyU1EifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tOWp0cmwiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiYzVjZTg4NTAtMWMzMy00MWU3LWIxN2QtMzM2YmNkZTRlYzZlIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.dK2ITEiw1hpWWugY5hOoLFF1-AA_9S--pQNjKZ6UiTkKcizZl4AjLyga7iPvBPFxfxBBe0xmfGHrFN0tO7NzY9XEZyXtLfUNSkF1xHwnM-IfyMOA2td2B7hFwA11G5Bl7fP-QSW_g0n8brokh6znQQ5Bbtziaih2ZM-zkyq-BRqMovukXnZW0k2OFyUMzCXV5NmgVrDCr_yg2LbkIYgv_B1uUZpd6A5Ebkxo6CYFxAhXQdUl4doh3Lq0HwuPfe7Pu0vK_1KmdLXQoTNQpwXlBmNh0THA4A0MxlC_VpxUUkrghh0qf3J1-uWo7X2YD41TMfudeTfcfPFewB47yNgyyg
<span class="hljs-meta">
#</span><span class="bash"> 读取token</span>
<span class="hljs-meta">#</span><span class="bash"> kubectl get secret -n kube-system | grep admin | awk <span class="hljs-string">'{print $1}'</span></span>
kubectl describe secret -n kube-system $(kubectl get secret -n kube-system | grep admin | awk '{print $1}')  | grep '^token' | awk '{print $2}'

eyJhbGciOiJSUzI1NiIsImtpZCI6Il9HcDhZZmNiVTVHVTZsbDhxY29DNVUybnYzREZxMFUySGpLYmVxWGtyU1EifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tOWp0cmwiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiYzVjZTg4NTAtMWMzMy00MWU3LWIxN2QtMzM2YmNkZTRlYzZlIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.dK2ITEiw1hpWWugY5hOoLFF1-AA_9S--pQNjKZ6UiTkKcizZl4AjLyga7iPvBPFxfxBBe0xmfGHrFN0tO7NzY9XEZyXtLfUNSkF1xHwnM-IfyMOA2td2B7hFwA11G5Bl7fP-QSW_g0n8brokh6znQQ5Bbtziaih2ZM-zkyq-BRqMovukXnZW0k2OFyUMzCXV5NmgVrDCr_yg2LbkIYgv_B1uUZpd6A5Ebkxo6CYFxAhXQdUl4doh3Lq0HwuPfe7Pu0vK_1KmdLXQoTNQpwXlBmNh0THA4A0MxlC_VpxUUkrghh0qf3J1-uWo7X2YD41TMfudeTfcfPFewB47yNgyyg
</code></pre>
<h1 id="%E4%B8%83%E3%80%81%E7%8A%B6%E6%80%81%E6%9F%A5%E7%9C%8B">七、状态查看 <a class="header-anchor" href="#%E4%B8%83%E3%80%81%E7%8A%B6%E6%80%81%E6%9F%A5%E7%9C%8B">#</a></h1>
<ol>
<li>查看节点状态</li>
</ol>
<blockquote>
<p>kubectl get nodes</p>
</blockquote>
<ol start="2">
<li>查看pod状态</li>
</ol>
<blockquote>
<p>kubectl get pod --all-namespaces</p>
</blockquote>
<ol>
<li>查看副本数</li>
</ol>
<blockquote>
<p>kubectl get deployments --all-namespaces
kubectl get pod -o wide --all-namespaces</p>
</blockquote>
<ol start="4">
<li>查看deployment详细信息</li>
</ol>
<blockquote>
<p>kubectl describe deployments --all-namespaces</p>
</blockquote>
<ol start="5">
<li>查看集群基本组件状态</li>
</ol>
<blockquote>
<p>kubectl get cs</p>
</blockquote>
<pre><code class="language-shell">NAME                 STATUS    MESSAGE             ERROR
scheduler            Healthy   ok
controller-manager   Healthy   ok
etcd-0               Healthy   {"health":"true"}
</code></pre>
<h1 id="%E5%85%AB%E3%80%81%E9%83%A8%E7%BD%B2%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1">八、部署业务服务 <a class="header-anchor" href="#%E5%85%AB%E3%80%81%E9%83%A8%E7%BD%B2%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1">#</a></h1>
<h3 id="1.-%E5%88%9B%E5%BB%BA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4">1. 创建命名空间 <a class="header-anchor" href="#1.-%E5%88%9B%E5%BB%BA%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4">#</a></h3>
<blockquote>
<p>kubectl create namespace svc-pd-service</p>
</blockquote>
<h3 id="2.-%E7%BC%96%E5%86%99yaml%E6%96%87%E4%BB%B6">2. 编写yaml文件 <a class="header-anchor" href="#2.-%E7%BC%96%E5%86%99yaml%E6%96%87%E4%BB%B6">#</a></h3>
<pre><code class="language-yaml">
</code></pre>
<h3 id="3.-%E6%89%A7%E8%A1%8C%E9%83%A8%E7%BD%B2">3. 执行部署 <a class="header-anchor" href="#3.-%E6%89%A7%E8%A1%8C%E9%83%A8%E7%BD%B2">#</a></h3>
<pre><code class="language-shell">
</code></pre>
<h1 id="%E5%8D%81%E3%80%81%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">十、异常处理 <a class="header-anchor" href="#%E5%8D%81%E3%80%81%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86">#</a></h1>
<ol>
<li>CGroup与Docker不匹配，CPU核心数至少要两个，需要关闭Swap分区</li>
</ol>
<pre><code class="language-shell"><span class="hljs-meta">#</span><span class="bash"> 报错</span>
W0823 17:37:30.758727    2645 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]
[init] Using Kubernetes version: v1.18.0
[preflight] Running pre-flight checks
        [WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd". Please follow the guide at https://kubernetes.io/docs/setup/cri/
error execution phase preflight: [preflight] Some fatal errors occurred:
        [ERROR NumCPU]: the number of available CPUs 1 is less than the required 2
        [ERROR Swap]: running with swap on is not supported. Please disable swap
[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`
To see the stack trace of this error execute with --v=5 or higher
<span class="hljs-meta">
#</span><span class="bash"> 解决方案</span>
<span class="hljs-meta">
#</span><span class="bash"> 查看docker的 Cgroup Driver，显示为cgroupfs，而kubelet为systemd</span>
sudo docker info | grep Cgroup 
<span class="hljs-meta">#</span><span class="bash"> 加入 <span class="hljs-string">"exec-opts"</span>: [<span class="hljs-string">"native.cgroupdriver=systemd"</span>]</span>
vim /etc/docker/daemon.json
"exec-opts": ["native.cgroupdriver=systemd"]
<span class="hljs-meta">
#</span><span class="bash"> 重启Docker和K8s</span>
systemctl daemon-reload &amp;&amp; systemctl restart docker &amp;&amp; systemctl restart kubelet
</code></pre>
</div></section><footer class="footer-container"><div class="footer-body"><img src="/light-docs/img/dubbo_gray.png"/><div class="cols-container"><div class="col col-12"><h3>Disclaimer</h3><p>the disclaimer content</p></div><div class="col col-6"><dl><dt>Documentation</dt><dd><a href="/light-docs/en-us/docs/index.html" target="_self">Overview</a></dd><dd><a href="/light-docs/en-us/docs/index.html" target="_self">Quick start</a></dd><dd><a href="/light-docs/en-us/docs/index.html" target="_self">Developer guide</a></dd></dl></div><div class="col col-6"><dl><dt>Resources</dt><dd><a href="/light-docs/en-us/blog/index.html" target="_self">Blog</a></dd><dd><a href="/light-docs/en-us/community/index.html" target="_self">Community</a></dd></dl></div></div><div class="copyright"><span>Copyright © 2018 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '/light-docs';
  </script>
	<script src="/light-docs/build/documentation.js"></script>
</body>
</html>